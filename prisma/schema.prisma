generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  firstName String?
  lastName  String?
  email     String   @unique
  password  String
  refreshToken     String?
  resetToken       String?
  resetTokenExpiry DateTime?
  member    Member?

  @@map("users")
}

model Organization {
  id          Int       @id @default(autoincrement())
  name        String    @default("Untitled")
  description String?
  bots        Bot[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  channels    Channel[]
  members     Member[]
  products    Product[]
  orders      Order[]

  @@map("organizations")
}

model Member {
  id             Int          @id @default(autoincrement())
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id])
  userId         Int          @unique
  user           User         @relation(fields: [userId], references: [id])
  role           MemberRole   @default(ADMIN)
  status         MemberStatus @default(INACTIVE)
  createdAt      DateTime     @default(now())

  @@unique([userId, organizationId])
  @@map("members")
}

enum MemberStatus {
  INACTIVE
  ACTIVE
}

enum MemberRole {
  ADMIN
  SELLER
}

model Bot {
  id             Int            @id @default(autoincrement())
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  token          String         @unique
  isEnabled      Boolean        @default(true)
  organizationId Int
  organization   Organization   @relation(fields: [organizationId], references: [id])
  conversations  Conversation[]

  @@map("bots")
}

model Conversation {
  id        String    @id @unique
  createdAt DateTime  @default(now())
  botId     Int
  bot       Bot       @relation(fields: [botId], references: [id])
  messages  Message[]

  @@map("conversations")
}

model Message {
  id             String       @id @default(cuid())
  createdAt      DateTime     @default(now())
  sender         SenderType
  content        String
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id])

  @@map("messages")
}

model Product {
  id             Int      @id @default(autoincrement())
  organizationId Int
  name           String
  description    String?
  price          Decimal? @db.Decimal(10, 2)
  stock          Int      @default(0)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("products")
}

model Order {
  id              Int          @id @default(autoincrement())
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  status          OrderStatus  @default(PENDING)
  customerName    String?
  customerContact String?
  customerAddress String?
  details         Json
  organizationId  Int
  organization    Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId, createdAt(sort: Desc)], name: "idx_orders_organization_created")
  @@index([status], name: "idx_orders_status")
  @@index([customerContact], name: "idx_orders_customer_contact")
  @@index([organizationId, status], name: "idx_orders_organization_status")
  @@index([createdAt(sort: Desc)], name: "idx_orders_created_at")
  @@index([organizationId, createdAt(sort: Desc), status], name: "idx_orders_organization_created_status")
  @@map("orders")
}

model Channel {
  id             Int          @id @default(autoincrement())
  telegramId     BigInt       @unique
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  title          String
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("channels")
}

enum CompanyType {
  CLOTHING
  FOOD
  FURNITURE
  ELECTRONICS
  COSMETICS
  TOYS
  BOOKS
  SPORTS
  HEALTH
  OTHER
}

enum SenderType {
  USER
  BOT
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
}
