generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               Int       @id @default(autoincrement())
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  firstName        String?
  lastName         String?
  email            String    @unique
  password         String
  refreshToken     String?
  resetToken       String?
  resetTokenExpiry DateTime?
  member           Member?
  files            File[]
  @@map("users")
}

model Organization {
  id          Int            @id @default(autoincrement())
  name        String         @default("Untitled")
  description String?
  category    BUSINESS_CATEGORY @default(OTHER)
  bots        Bot[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  channels    Channel[]
  members     Member[]
  products    Product[]
  orders      Order[]
  schema      ProductSchema?
  files       File[]
  @@map("organizations")
}

enum BUSINESS_CATEGORY {
  FASHION
  ELECTRONICS
  COSMETICS
  SERVICES
  FOOD
  BOOKS
  HOME
  SPORTS
  AUTOMOTIVE
  OTHER
}

model Product {
  id             Int    @id @default(autoincrement())
  name           String
  price          Float
  images         File[]

  schemaId     Int
  schema       ProductSchema @relation(fields: [schemaId], references: [id])
  fields       FieldValue[]
  organizationId Int
  organization Organization  @relation(fields: [organizationId], references: [id])
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt()

  @@index([name])
  @@index([organizationId, createdAt])
  @@map("products")
}

model ProductSchema {
  id             Int          @id @default(autoincrement())
  name           String
  fields         Field[]
  products       Product[]
  organizationId Int          @unique
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@map("product_schemas")
}

model Field {
  id          Int           @id @default(autoincrement())
  schemaId    Int
  schema      ProductSchema @relation(fields: [schemaId], references: [id])
  name        String
  type        FieldType
  required    Boolean
  order       Int           @default(0)
  options     String[]      @default([]) // For ENUM field types
  fieldValues FieldValue[]

  @@map("schema_fields")
}

model FieldValue {
  id        Int  @id @default(autoincrement())
  productId Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  fieldId   Int
  field   Field @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  // qiymatni universal saqlash uchun:
  valueText   String?
  valueNumber Float?
  valueBool   Boolean?
  valueDate   DateTime?
  valueJson   Json? // ENUM, FILE, IMAGE va boshqalar uchun

  @@unique([productId, fieldId]) // har bir product uchun field bir marta bo'lishi kerak
  @@index([valueText])
  @@index([productId])
  @@map("field_values")
}

enum FieldType {
  TEXT
  NUMBER
  DATE
  FILE
  BOOLEAN
  ENUM
  IMAGE
}

model File {
  id             Int        @id @default(autoincrement())
  key            String     @unique // relative path: "public/uploads/abc.png"
  originalName   String
  size           Int
  mimeType       String
  type           FileType   @default(OTHER)
  status         FileStatus @default(READY)
  createdAt      DateTime   @default(now())

  // Relations
  uploaderId     Int?
  uploader       User?       @relation(fields: [uploaderId], references: [id])
  productId      Int?
  product        Product?    @relation(fields: [productId], references: [id])
  organizationId Int?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@index([originalName])
  @@index([organizationId, createdAt])
  @@map("files")
}

enum FileType {
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  OTHER
}

enum FileStatus {
  PENDING
  READY
  FAILED
}

model Member {
  id             Int          @id @default(autoincrement())
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id])
  userId         Int          @unique
  user           User         @relation(fields: [userId], references: [id])
  role           MemberRole   @default(ADMIN)
  status         MemberStatus @default(INACTIVE)
  createdAt      DateTime     @default(now())

  @@unique([userId, organizationId])
  @@map("members")
}

enum MemberStatus {
  INACTIVE
  ACTIVE
}

enum MemberRole {
  ADMIN
  SELLER
}

model Bot {
  id             Int            @id @default(autoincrement())
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  token          String         @unique
  isEnabled      Boolean        @default(true)
  telegramId     String
  name           String
  username       String
  organizationId Int
  organization   Organization   @relation(fields: [organizationId], references: [id])
  conversations  Conversation[]

  @@index([organizationId, name])
  @@index([organizationId, username])
  @@map("bots")
}

model Conversation {
  id        String    @id @unique
  createdAt DateTime  @default(now())
  botId     Int
  bot       Bot       @relation(fields: [botId], references: [id])
  messages  Message[]

  @@map("conversations")
}

model Message {
  id             String       @id @default(cuid())
  createdAt      DateTime     @default(now())
  sender         SenderType
  content        String
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id])

  @@map("messages")
}

// model Product {
//   id             Int      @id @default(autoincrement())
//   organizationId Int
//   name           String
//   description    String?
//   price          Decimal? @db.Decimal(10, 2)
//   stock          Int      @default(0)
//   isActive       Boolean  @default(true)
//   createdAt      DateTime @default(now())
//   updatedAt      DateTime @updatedAt

//   organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

//   @@map("products")
// }

model Order {
  id              Int          @id @default(autoincrement())
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  status          OrderStatus  @default(PENDING)
  customerName    String?
  customerContact String?
  customerAddress String?
  details         Json
  organizationId  Int
  organization    Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId, createdAt(sort: Desc)], name: "idx_orders_organization_created")
  @@index([status], name: "idx_orders_status")
  @@index([customerContact], name: "idx_orders_customer_contact")
  @@index([organizationId, status], name: "idx_orders_organization_status")
  @@index([createdAt(sort: Desc)], name: "idx_orders_created_at")
  @@index([organizationId, createdAt(sort: Desc), status], name: "idx_orders_organization_created_status")
  @@map("orders")
}

model Channel {
  id             Int          @id @default(autoincrement())
  telegramId     BigInt       @unique
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  title          String
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("channels")
}

enum CompanyType {
  CLOTHING
  FOOD
  FURNITURE
  ELECTRONICS
  COSMETICS
  TOYS
  BOOKS
  SPORTS
  HEALTH
  OTHER
}

enum SenderType {
  USER
  BOT
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
}
